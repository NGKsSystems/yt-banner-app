<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NGKs Banner Editor</title>
  <style>
    body {
      background-color: #111;
      color: #fff;
      text-align: center;
      font-family: Arial, sans-serif;
    }
    canvas {
      border: 2px solid yellow;
      display: block;
      margin: 10px auto;
      background-color: #000;
    }
    input[type="file"] {
      margin: 5px;
    }
    .handle {
      width: 8px;
      height: 8px;
      background-color: white;
      border: 1px solid black;
      position: absolute;
      z-index: 10;
      cursor: pointer;
    }
    #controlPanel {
      margin-bottom: 10px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h3>NGKs Banner Editor</h3>
  <div id="stepText">Step 1: Choose your background image</div>
  <input type="file" id="bgInput" accept="image/*"/>
  <button id="skipBgBtn">Skip</button>
  <br/>
  <canvas id="bannerCanvas" width="2560" height="1440"></canvas>
  <div id="controlPanel" class="hidden">
    <button id="clearBtn">Clear Canvas</button>
    <button id="deleteBtn">Delete Selected</button>
    <button id="exportBtn">Export Banner</button>
  </div>

  <script>
    const canvas = document.getElementById("bannerCanvas");
    const ctx = canvas.getContext("2d");

    const bgInput = document.getElementById("bgInput");
    const skipBtn = document.getElementById("skipBgBtn");
    const stepText = document.getElementById("stepText");
    const controlPanel = document.getElementById("controlPanel");
    const deleteBtn = document.getElementById("deleteBtn");
    const clearBtn = document.getElementById("clearBtn");
    const exportBtn = document.getElementById("exportBtn");

    let step = 1;
    let images = [];
    let selectedImageIndex = null;
    let dragOffset = { x: 0, y: 0 };
    let dragging = false;
    let resizing = false;
    let resizeDir = "";
    const handles = [];

    const mobileZone = {
      x: 740,
      y: 620,
      width: 1080,
      height: 200
    };

    function drawCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      images.forEach((imgObj, i) => {
        ctx.drawImage(imgObj.img, imgObj.x, imgObj.y, imgObj.w, imgObj.h);
        if (i === selectedImageIndex) {
          ctx.strokeStyle = "lime";
          ctx.strokeRect(imgObj.x, imgObj.y, imgObj.w, imgObj.h);
        }
      });

      // Safe zone overlay
      ctx.strokeStyle = "green";
      ctx.strokeRect(mobileZone.x, mobileZone.y, mobileZone.width, mobileZone.height);
    }

    function updateHandles() {
      handles.forEach(h => document.body.removeChild(h));
      handles.length = 0;
      if (selectedImageIndex === null) return;

      const img = images[selectedImageIndex];
      const dirs = ["nw", "n", "ne", "e", "se", "s", "sw", "w"];
      const pos = [
        [img.x, img.y],
        [img.x + img.w / 2, img.y],
        [img.x + img.w, img.y],
        [img.x + img.w, img.y + img.h / 2],
        [img.x + img.w, img.y + img.h],
        [img.x + img.w / 2, img.y + img.h],
        [img.x, img.y + img.h],
        [img.x, img.y + img.h / 2]
      ];

      pos.forEach(([x, y], i) => {
        const handle = document.createElement("div");
        handle.className = "handle";
        handle.style.left = `${canvas.offsetLeft + x - 4}px`;
        handle.style.top = `${canvas.offsetTop + y - 4}px`;
        handle.dataset.dir = dirs[i];
        document.body.appendChild(handle);
        handles.push(handle);
      });
    }

    function setStepText(s) {
      stepText.textContent = s;
    }

    function loadImage(file, callback) {
      const reader = new FileReader();
      reader.onload = e => {
        const img = new Image();
        img.onload = () => callback(img);
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    bgInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      loadImage(file, img => {
        images = [{ img, x: 0, y: 0, w: canvas.width, h: canvas.height }];
        step = 2;
        setStepText("Step 2: Choose your mobile view image (autoplaced)");
        bgInput.value = "";
        drawCanvas();
      });
    });

    skipBtn.addEventListener("click", () => {
      step = 2;
      setStepText("Step 2: Choose your mobile view image (autoplaced)");
    });

    canvas.addEventListener("click", e => {
      const x = e.offsetX;
      const y = e.offsetY;
      selectedImageIndex = null;
      for (let i = images.length - 1; i > 0; i--) {
        const img = images[i];
        if (x >= img.x && x <= img.x + img.w && y >= img.y && y <= img.y + img.h) {
          selectedImageIndex = i;
          break;
        }
      }
      updateHandles();
      drawCanvas();
    });

    canvas.addEventListener("mousedown", e => {
      if (selectedImageIndex === null) return;
      const img = images[selectedImageIndex];
      const x = e.offsetX, y = e.offsetY;

      // Resize check
      for (const h of handles) {
        const rect = h.getBoundingClientRect();
        if (x + canvas.offsetLeft >= rect.left && x + canvas.offsetLeft <= rect.right &&
            y + canvas.offsetTop >= rect.top && y + canvas.offsetTop <= rect.bottom) {
          resizing = true;
          resizeDir = h.dataset.dir;
          return;
        }
      }

      // Drag check
      if (x >= img.x && x <= img.x + img.w && y >= img.y && y <= img.y + img.h) {
        dragging = true;
        dragOffset.x = x - img.x;
        dragOffset.y = y - img.y;
      }
    });

    canvas.addEventListener("mousemove", e => {
      if (selectedImageIndex === null) return;
      const img = images[selectedImageIndex];
      const x = e.offsetX, y = e.offsetY;

      if (dragging) {
        img.x = x - dragOffset.x;
        img.y = y - dragOffset.y;
        drawCanvas();
        updateHandles();
      } else if (resizing) {
        const oldW = img.w, oldH = img.h;
        if (resizeDir.includes("e")) img.w = x - img.x;
        if (resizeDir.includes("s")) img.h = y - img.y;
        if (resizeDir.includes("w")) {
          img.w += img.x - x;
          img.x = x;
        }
        if (resizeDir.includes("n")) {
          img.h += img.y - y;
          img.y = y;
        }
        drawCanvas();
        updateHandles();
      }
    });

    canvas.addEventListener("mouseup", () => {
      dragging = false;
      resizing = false;
    });

    document.addEventListener("keydown", e => {
      if (selectedImageIndex === null) return;
      const img = images[selectedImageIndex];
      if (e.key === "ArrowLeft") img.x -= 1;
      if (e.key === "ArrowRight") img.x += 1;
      if (e.key === "ArrowUp") img.y -= 1;
      if (e.key === "ArrowDown") img.y += 1;
      drawCanvas();
      updateHandles();
    });

    canvas.addEventListener("dragover", e => e.preventDefault());
    canvas.addEventListener("drop", e => e.preventDefault());

    canvas.addEventListener("dblclick", () => {
      if (step === 2) {
        // Prompt user for image upload via file dialog
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.onchange = () => {
          const file = input.files[0];
          loadImage(file, img => {
            const w = mobileZone.width;
            const h = mobileZone.height;
            const x = mobileZone.x;
            const y = mobileZone.y;
            images.push({ img, x, y, w, h });
            step = 3;
            setStepText("Step 3: Add additional images (movable, resizable, deletable)");
            controlPanel.classList.remove("hidden");
            drawCanvas();
          });
        };
        input.click();
      } else if (step >= 3) {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.onchange = () => {
          const file = input.files[0];
          loadImage(file, img => {
            images.push({ img, x: 100, y: 100, w: 300, h: 100 });
            drawCanvas();
          });
        };
        input.click();
      }
    });

    deleteBtn.addEventListener("click", () => {
      if (selectedImageIndex !== null && selectedImageIndex > 0) {
        images.splice(selectedImageIndex, 1);
        selectedImageIndex = null;
        updateHandles();
        drawCanvas();
      }
    });

    clearBtn.addEventListener("click", () => {
      images = [];
      selectedImageIndex = null;
      step = 1;
      setStepText("Step 1: Choose your background image");
      controlPanel.classList.add("hidden");
      updateHandles();
      drawCanvas();
    });

    exportBtn.addEventListener("click", () => {
      handles.forEach(h => document.body.removeChild(h));
      handles.length = 0;
      drawCanvas();
      const link = document.createElement("a");
      link.download = "yt_banner_final.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
      updateHandles();
    });
  </script>
</body>
</html>

