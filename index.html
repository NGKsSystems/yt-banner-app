<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NGKs Banner Editor</title>
  <style>
    body {
      background: #111;
      color: white;
      text-align: center;
      font-family: Arial, sans-serif;
    }
    canvas {
      border: 2px solid yellow;
      display: block;
      margin: 20px auto;
    }
    .hidden {
      display: none;
    }
    .handle {
      width: 10px;
      height: 10px;
      background: white;
      border: 1px solid black;
      position: absolute;
      z-index: 10;
      cursor: nwse-resize;
    }
    .controls button {
      margin: 5px;
    }
  </style>
</head>
<body>
  <h3>NGKs Banner Editor</h3>
  <div id="stepInstructions">Step 1: Choose your background image</div>
  <input type="file" id="bgInput" accept="image/*" />
  <button id="skipBG">Skip</button>
  <input type="file" id="mobileInput" accept="image/*" class="hidden" />
  <input type="file" id="extraInput" accept="image/*" class="hidden" />
  <div id="exportControls" class="hidden controls">
    <button id="clearCanvas">Clear Canvas</button>
    <button id="deleteSelected">Delete Selected</button>
    <button id="exportBtn">Export Banner</button>
  </div>
  <canvas id="bannerCanvas" width="2560" height="1440"></canvas>

  <script>
    const canvas = document.getElementById("bannerCanvas");
    const ctx = canvas.getContext("2d");

    const bgInput = document.getElementById("bgInput");
    const skipBG = document.getElementById("skipBG");
    const mobileInput = document.getElementById("mobileInput");
    const extraInput = document.getElementById("extraInput");
    const stepInstructions = document.getElementById("stepInstructions");
    const exportControls = document.getElementById("exportControls");
    const clearCanvasBtn = document.getElementById("clearCanvas");
    const deleteSelectedBtn = document.getElementById("deleteSelected");
    const exportBtn = document.getElementById("exportBtn");

    let images = [];
    let selectedIndex = null;
    let dragging = false;
    let resizing = false;
    let dragOffsetX = 0;
    let dragOffsetY = 0;
    let resizeHandle = null;

    const handleSize = 10;
    const safeZone = { x: 507, y: 509, width: 1546, height: 423 };

    function drawCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      images.forEach((imgObj, i) => {
        ctx.drawImage(imgObj.img, imgObj.x, imgObj.y, imgObj.width, imgObj.height);
        if (i === selectedIndex) {
          // outline
          ctx.strokeStyle = "lime";
          ctx.strokeRect(imgObj.x, imgObj.y, imgObj.width, imgObj.height);
          // handles
          drawHandles(imgObj);
        }
      });

      // safe zone overlay
      ctx.strokeStyle = "lime";
      ctx.lineWidth = 1;
      ctx.strokeRect(safeZone.x, safeZone.y, safeZone.width, safeZone.height);
    }

    function drawHandles(imgObj) {
      const x = imgObj.x;
      const y = imgObj.y;
      const w = imgObj.width;
      const h = imgObj.height;
      const points = [
        [x, y], [x + w / 2, y], [x + w, y],
        [x, y + h / 2], [x + w, y + h / 2],
        [x, y + h], [x + w / 2, y + h], [x + w, y + h]
      ];
      ctx.fillStyle = "white";
      ctx.strokeStyle = "black";
      points.forEach(([px, py]) => {
        ctx.fillRect(px - 5, py - 5, handleSize, handleSize);
        ctx.strokeRect(px - 5, py - 5, handleSize, handleSize);
      });
    }

    function getHandleUnderCursor(x, y, imgObj) {
      const handles = [
        { name: "tl", x: imgObj.x, y: imgObj.y },
        { name: "tr", x: imgObj.x + imgObj.width, y: imgObj.y },
        { name: "bl", x: imgObj.x, y: imgObj.y + imgObj.height },
        { name: "br", x: imgObj.x + imgObj.width, y: imgObj.y + imgObj.height }
      ];
      return handles.find(h =>
        x >= h.x - 5 && x <= h.x + 5 &&
        y >= h.y - 5 && y <= h.y + 5
      )?.name || null;
    }

    canvas.addEventListener("mousedown", e => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      for (let i = images.length - 1; i >= 0; i--) {
        const img = images[i];
        if (
          x >= img.x &&
          x <= img.x + img.width &&
          y >= img.y &&
          y <= img.y + img.height
        ) {
          selectedIndex = i;
          resizeHandle = getHandleUnderCursor(x, y, img);
          if (resizeHandle) {
            resizing = true;
          } else {
            dragging = true;
            dragOffsetX = x - img.x;
            dragOffsetY = y - img.y;
          }
          drawCanvas();
          return;
        }
      }

      selectedIndex = null;
      drawCanvas();
    });

    canvas.addEventListener("mousemove", e => {
      if (selectedIndex === null) return;
      const img = images[selectedIndex];
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      if (resizing) {
        const dx = x - img.x;
        const dy = y - img.y;
        img.width = Math.max(10, dx);
        img.height = Math.max(10, dy);
      } else if (dragging) {
        img.x = x - dragOffsetX;
        img.y = y - dragOffsetY;
      }

      drawCanvas();
    });

    canvas.addEventListener("mouseup", () => {
      dragging = false;
      resizing = false;
    });

    document.addEventListener("keydown", e => {
      const img = images[selectedIndex];
      if (!img) return;
      const move = e.shiftKey ? 10 : 1;
      switch (e.key) {
        case "ArrowUp": img.y -= move; break;
        case "ArrowDown": img.y += move; break;
        case "ArrowLeft": img.x -= move; break;
        case "ArrowRight": img.x += move; break;
      }
      drawCanvas();
    });

    bgInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const img = new Image();
        img.onload = () => {
          images = [{ img, x: 0, y: 0, width: canvas.width, height: canvas.height }];
          stepInstructions.textContent = "Step 2: Choose your mobile view image (autoplaced)";
          bgInput.classList.add("hidden");
          skipBG.classList.add("hidden");
          mobileInput.classList.remove("hidden");
          drawCanvas();
        };
        img.src = evt.target.result;
      };
      reader.readAsDataURL(file);
    });

    skipBG.addEventListener("click", () => {
      stepInstructions.textContent = "Step 2: Choose your mobile view image (autoplaced)";
      bgInput.classList.add("hidden");
      skipBG.classList.add("hidden");
      mobileInput.classList.remove("hidden");
      drawCanvas();
    });

    mobileInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const img = new Image();
        img.onload = () => {
          images.push({
            img,
            x: safeZone.x,
            y: safeZone.y,
            width: safeZone.width,
            height: safeZone.height
          });
          stepInstructions.textContent = "Step 3: Add additional images (movable, resizable, deletable)";
          mobileInput.classList.add("hidden");
          extraInput.classList.remove("hidden");
          exportControls.classList.remove("hidden");
          drawCanvas();
        };
        img.src = evt.target.result;
      };
      reader.readAsDataURL(file);
    });

    extraInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const img = new Image();
        img.onload = () => {
          images.push({
            img,
            x: 100,
            y: 100,
            width: 300,
            height: 100
          });
          drawCanvas();
        };
        img.src = evt.target.result;
      };
      reader.readAsDataURL(file);
    });

    clearCanvasBtn.addEventListener("click", () => {
      images = [];
      selectedIndex = null;
      drawCanvas();
    });

    deleteSelectedBtn.addEventListener("click", () => {
      if (selectedIndex !== null) {
        images.splice(selectedIndex, 1);
        selectedIndex = null;
        drawCanvas();
      }
    });

    exportBtn.addEventListener("click", () => {
      const temp = ctx.getImageData(0, 0, canvas.width, canvas.height);
      drawCanvas(); // ensure clean render
      const link = document.createElement("a");
      link.download = "yt_banner_final.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    });

    drawCanvas(); // initialize empty canvas
  </script>
</body>
</html>
