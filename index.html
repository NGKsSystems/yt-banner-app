<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>YT Banner Editor</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #222; color: #fff; }
    canvas { background: #111; border: 2px solid #fff; margin-top: 10px; }
    .step { display: none; font-size: 20px; margin-top: 20px; }
    .active { display: block; }
    .btn { font-size: 18px; padding: 10px 20px; margin: 5px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>YouTube Banner Editor â€“ NGKsSystems</h2>
  <div id="step1" class="step active">
    <p>Step 1: Upload Background Image</p>
    <input type="file" id="bgUpload" />
  </div>
  <div id="step2" class="step">
    <p>Step 2: Upload Mobile Safe Zone Image</p>
    <input type="file" id="mobileUpload" />
  </div>
  <div id="step3" class="step">
    <p>Step 3: Upload Additional Image(s)</p>
    <input type="file" id="imgUpload" multiple />
  </div>
  <div id="step4" class="step">
    <p>Step 4: Export</p>
    <button class="btn" id="exportBtn">Export Banner</button>
  </div>

  <canvas id="canvas" width="2560" height="1440"></canvas>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let background = null;
    const overlays = [];
    let selected = null;
    let dragOffsetX = 0;
    let dragOffsetY = 0;
    let resizeHandle = null;

    const steps = ["step1", "step2", "step3", "step4"];
    let currentStep = 0;

    function nextStep() {
      document.getElementById(steps[currentStep]).classList.remove("active");
      currentStep++;
      if (currentStep < steps.length) {
        document.getElementById(steps[currentStep]).classList.add("active");
      }
    }

    function drawCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (background) ctx.drawImage(background, 0, 0, canvas.width, canvas.height);
      overlays.forEach(o => {
        ctx.drawImage(o.img, o.x, o.y, o.width, o.height);
        if (o === selected) drawHandles(o);
      });
    }

    function drawHandles(o) {
      const size = 10;
      const handles = [
        [o.x, o.y],
        [o.x + o.width / 2, o.y],
        [o.x + o.width, o.y],
        [o.x, o.y + o.height / 2],
        [o.x + o.width, o.y + o.height / 2],
        [o.x, o.y + o.height],
        [o.x + o.width / 2, o.y + o.height],
        [o.x + o.width, o.y + o.height]
      ];
      ctx.fillStyle = "#fff";
      handles.forEach(([x, y]) => {
        ctx.fillRect(x - size / 2, y - size / 2, size, size);
      });
    }

    function hitTestHandle(x, y, o) {
      const size = 10;
      const handles = [
        [o.x, o.y],
        [o.x + o.width / 2, o.y],
        [o.x + o.width, o.y],
        [o.x, o.y + o.height / 2],
        [o.x + o.width, o.y + o.height / 2],
        [o.x, o.y + o.height],
        [o.x + o.width / 2, o.y + o.height],
        [o.x + o.width, o.y + o.height]
      ];
      return handles.findIndex(([hx, hy]) =>
        x >= hx - size / 2 && x <= hx + size / 2 &&
        y >= hy - size / 2 && y <= hy + size / 2
      );
    }

    canvas.addEventListener("mousedown", e => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      for (let i = overlays.length - 1; i >= 0; i--) {
        const o = overlays[i];
        const handle = hitTestHandle(x, y, o);
        if (handle !== -1) {
          selected = o;
          resizeHandle = handle;
          return;
        }
        if (x >= o.x && x <= o.x + o.width && y >= o.y && y <= o.y + o.height) {
          selected = o;
          dragOffsetX = x - o.x;
          dragOffsetY = y - o.y;
          resizeHandle = null;
          drawCanvas();
          return;
        }
      }
      selected = null;
      drawCanvas();
    });

    canvas.addEventListener("mousemove", e => {
      if (!selected) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      if (resizeHandle !== null) {
        let o = selected;
        let minSize = 30;

        switch (resizeHandle) {
          case 0:
            o.width += o.x - x;
            o.height += o.y - y;
            o.x = x;
            o.y = y;
            break;
          case 1:
            o.height += o.y - y;
            o.y = y;
            break;
          case 2:
            o.width = x - o.x;
            o.height += o.y - y;
            o.y = y;
            break;
          case 3:
            o.width += o.x - x;
            o.x = x;
            break;
          case 4:
            o.width = x - o.x;
            break;
          case 5:
            o.width += o.x - x;
            o.height = y - o.y;
            o.x = x;
            break;
          case 6:
            o.height = y - o.y;
            break;
          case 7:
            o.width = x - o.x;
            o.height = y - o.y;
            break;
        }

        // enforce min size
        o.width = Math.max(minSize, o.width);
        o.height = Math.max(minSize, o.height);
        drawCanvas();
        return;
      }

      // drag
      selected.x = x - dragOffsetX;
      selected.y = y - dragOffsetY;
      drawCanvas();
    });

    canvas.addEventListener("mouseup", () => {
      resizeHandle = null;
    });

    document.addEventListener("keydown", e => {
      if (!selected) return;
      const delta = 5;
      switch (e.key) {
        case "ArrowUp": selected.y -= delta; break;
        case "ArrowDown": selected.y += delta; break;
        case "ArrowLeft": selected.x -= delta; break;
        case "ArrowRight": selected.x += delta; break;
      }
      drawCanvas();
    });

    function loadImage(file, callback) {
      const img = new Image();
      img.onload = () => callback(img);
      img.src = URL.createObjectURL(file);
    }

    document.getElementById("bgUpload").addEventListener("change", e => {
      loadImage(e.target.files[0], img => {
        background = img;
        drawCanvas();
        nextStep();
      });
    });

    document.getElementById("mobileUpload").addEventListener("change", e => {
      loadImage(e.target.files[0], img => {
        overlays.push({ img, x: 740, y: 620, width: 1080, height: 200 });
        drawCanvas();
        nextStep();
      });
    });

    document.getElementById("imgUpload").addEventListener("change", e => {
      Array.from(e.target.files).forEach(file => {
        loadImage(file, img => {
          overlays.push({ img, x: 100, y: 100, width: 400, height: 300 });
          drawCanvas();
        });
      });
      nextStep();
    });

    document.getElementById("exportBtn").addEventListener("click", () => {
      // Temporarily hide handles before export
      const temp = selected;
      selected = null;
      drawCanvas();
      const link = document.createElement("a");
      link.download = "yt_banner_final.png";
      link.href = canvas.toDataURL();
      link.click();
      selected = temp;
      drawCanvas();
    });
  </script>
</body>
</html>
